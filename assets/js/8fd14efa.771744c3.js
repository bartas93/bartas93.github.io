"use strict";(self.webpackChunkbj_blog=self.webpackChunkbj_blog||[]).push([[3586],{2101:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>g,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var a=n(8168),r=(n(6540),n(5680));const o={slug:"string-in-jvm-memory",title:"Calculating the memory usage by a String in JVM - JOL Footprint",authors:"bjab",tags:["jvm","jol","string","heap","memory"]},s="Calculating memory usage by String in JVM - JOL Footprint",i={permalink:"/blog/string-in-jvm-memory",source:"@site/blog/2024-05-16-String-memory-usage-jvm.md",title:"Calculating the memory usage by a String in JVM - JOL Footprint",description:"In short:",date:"2024-05-16T00:00:00.000Z",formattedDate:"May 16, 2024",tags:[{label:"jvm",permalink:"/blog/tags/jvm"},{label:"jol",permalink:"/blog/tags/jol"},{label:"string",permalink:"/blog/tags/string"},{label:"heap",permalink:"/blog/tags/heap"},{label:"memory",permalink:"/blog/tags/memory"}],readingTime:6.615,hasTruncateMarker:!0,authors:[{name:"Bartek Jab\u0142o\u0144ski",title:"Backend Cloud Developer",url:"https://bartas93.github.io",imageURL:"/images/bartek_jablonski_2.png",key:"bjab"}],frontMatter:{slug:"string-in-jvm-memory",title:"Calculating the memory usage by a String in JVM - JOL Footprint",authors:"bjab",tags:["jvm","jol","string","heap","memory"]},prevItem:{title:"Regular expressions",permalink:"/blog/regular-expressions"},nextItem:{title:"Free YouTube Playlist Downloader to mp3 or mp4 - No Ads, No Hassle",permalink:"/blog/python-youtube-downloader"}},l={authorsImageUrls:[void 0]},c=[{value:"In short:",id:"in-short",level:2},{value:"JOL - String",id:"jol---string",level:2}],y={toc:c},b="wrapper";function g(e){let{components:t,...n}=e;return(0,r.yg)(b,(0,a.A)({},y,n,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("h2",{id:"in-short"},"In short:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"The memory of the String object consists of 24 bytes for metadata + the number of characters times 1 byte or 2 bytes depending on the coder value",(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"Metadata: mark word x2 (4 bytes x2 = 8 bytes), class word (4 bytes), array reference byte[] or char[] (4 byte), hash (4 byte), hashIsZero (1 byte), coder (1 byte), padding (2 byte)"))),(0,r.yg)("li",{parentName:"ul"},"The String object has 2 additional flags:",(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"when ",(0,r.yg)("inlineCode",{parentName:"li"},"coder =1")," then UTF-16 encoding (2 bytes per character)"),(0,r.yg)("li",{parentName:"ul"},"when ",(0,r.yg)("inlineCode",{parentName:"li"},"coder = 0")," then LATIN-1 encoding (1 byte per character)"),(0,r.yg)("li",{parentName:"ul"},"hashIsZero is a flag that tells whether the hash calculation has already been performed")))),(0,r.yg)("h2",{id:"jol---string"},"JOL - String"),(0,r.yg)("p",null,"Since Java 9 we use Compact String, i.e. if possible, we use LATIN-1 encoding, and if not, coder=1 is set and we use UTF-16."),(0,r.yg)("p",null,"(Before Java 9, everything was char[] and each letter was equal to 2 byte Utf-16.)"),(0,r.yg)("p",null,"If at least one character is other than latin-1 (1 byte), each character in the String is encoded in utf16 (2 byte)."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'String utf16String = "Bartosz Jab\u0142o\u0144ski"; // 17 znak\xf3w x 2 bytes = 34 bytes\nSystem.out.println(ClassLayout.parseInstance(utf16String).toPrintable());\nSystem.out.println(GraphLayout.parseInstance(utf16String).toFootprint());\nSystem.out.println(ClassLayout.parseInstance(utf16String.getBytes()).toPrintable());\nSystem.out.println(ClassLayout.parseInstance(utf16String.toCharArray()).toPrintable());\n       \nString latin1String = "Bartosz Jablonski"; // 17 znak\xf3w x 1 bytes = 17 bytes\nSystem.out.println(ClassLayout.parseInstance(latin1String).toPrintable());\nSystem.out.println(GraphLayout.parseInstance(latin1String).toFootprint());\nSystem.out.println(ClassLayout.parseInstance(latin1String.getBytes()).toPrintable());\nSystem.out.println(ClassLayout.parseInstance(latin1String.toCharArray()).toPrintable());\n')),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"#### Bartosz Jab\u0142o\u0144ski - UTF-16 - coder:1\njava.lang.String object internals:\n OFFSET  SIZE      TYPE DESCRIPTION                               VALUE\n      0     4           (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4           (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4           (object header)                           d8 e8 00 00 (11011000 11101000 00000000 00000000) (59608)\n     12     4       int String.hash                               0\n     16     1      byte String.coder                              1\n     17     1   boolean String.hashIsZero                         false\n     18     2           (alignment/padding gap)                  \n     20     4    byte[] String.value                              [66, 0, 97, 0, 114, 0, 116, 0, 111, 0, 115, 0, 122, 0, 32, 0, 74, 0, 97, 0, 98, 0, 66, 1, 111, 0, 68, 1, 115, 0, 107, 0, 105, 0]\nInstance size: 24 bytes\nSpace losses: 2 bytes internal + 0 bytes external = 2 bytes total\n\njava.lang.String@7dc222aed footprint:\n     COUNT       AVG       SUM   DESCRIPTION\n         1        56        56   [B\n         1        24        24   java.lang.String\n         2                  80   (total)\n\n[B object internals:\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4        (object header)                           c0 22 00 00 (11000000 00100010 00000000 00000000) (8896)\n     12     4        (object header)                           13 00 00 00 (00010011 00000000 00000000 00000000) (19)\n     16    19   byte [B.<elements>                             N/A\n     35     5        (loss due to the next object alignment)\nInstance size: 40 bytes\nSpace losses: 0 bytes internal + 5 bytes external = 5 bytes total\n\n[C object internals:\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4        (object header)                           f0 1c 00 00 (11110000 00011100 00000000 00000000) (7408)\n     12     4        (object header)                           11 00 00 00 (00010001 00000000 00000000 00000000) (17)\n     16    34   char [C.<elements>                             N/A\n     50     6        (loss due to the next object alignment)\nInstance size: 56 bytes\nSpace losses: 0 bytes internal + 6 bytes external = 6 bytes total\n")),(0,r.yg)("p",null,"In the first case, for ",(0,r.yg)("inlineCode",{parentName:"p"},"Bartosz Jab\u0142o\u0144ski"),", where we included Polish characters not included in LATIN-1, you can see that the String has the ",(0,r.yg)("inlineCode",{parentName:"p"},"coder")," flag set to ",(0,r.yg)("inlineCode",{parentName:"p"},"1"),", i.e. it uses the ",(0,r.yg)("inlineCode",{parentName:"p"},"UTF-16")," encoding type (2 bytes per character)."),(0,r.yg)("p",null,"The footprint shows the deep size of the String object (17 characters) is 80 bytes. It consists of String and its metadata and the String object, i.e. the char[] array in UTF-16 encoding (2 byte per character).\nTo sum up:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"24 bytes - String with a reference takes 24 bytes (12 bytes for metadata (headers) + 4 bytes for hash(int) + 1 byte for coder, + 1 byte for hashIsZero + 4 bytes of references to the char array + 2 bytes for alligment padding )."),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"Where the coder is responsible for: This value is closely related to the JVM implementation (hotspot). This is the encoding identifier used to encode bytes. Supported values are LATIN1 (coder=0) and UTF16(coder=1).\nIf at least one letter ",(0,r.yg)("strong",{parentName:"li"},"is not included in LATIN1"),", then coder=1 and the entire String will be encoded to UTF-16, i.e. it will take up (n letters * 2 bytes) in memory.",(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},"Where hashIsZero is responsible for: This field tells the JVM whether it can bypass hash recalculation. (this kind of cache)"))))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"56 bytes - The byte[] array occupies 56 bytes, which consists of: 12 bytes of metadata (headers) + 4 bytes of metadata about the array (length) + data 17 characters * 2 bytes (34 bytes) = 50 bytes + 6 bytes for alignment . This is non-intuitively illustrated by the line of code: ",(0,r.yg)("inlineCode",{parentName:"p"},"System.out.println(ClassLayout.parseInstance(utf16String.toCharArray()).toPrintable());")))),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},"#### Bartosz Jablonski - LATIN-1 - coder:0\njava.lang.String object internals:\n OFFSET  SIZE      TYPE DESCRIPTION                               VALUE\n      0     4           (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4           (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4           (object header)                           d8 e8 00 00 (11011000 11101000 00000000 00000000) (59608)\n     12     4       int String.hash                               0\n     16     1      byte String.coder                              0\n     17     1   boolean String.hashIsZero                         false\n     18     2           (alignment/padding gap)                  \n     20     4    byte[] String.value                              [66, 97, 114, 116, 111, 115, 122, 32, 74, 97, 98, 108, 111, 110, 115, 107, 105]\nInstance size: 24 bytes\nSpace losses: 2 bytes internal + 0 bytes external = 2 bytes total\n\njava.lang.String@48a242ced footprint:\n     COUNT       AVG       SUM   DESCRIPTION\n         1        40        40   [B\n         1        24        24   java.lang.String\n         2                  64   (total)\n\n[B object internals:\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4        (object header)                           c0 22 00 00 (11000000 00100010 00000000 00000000) (8896)\n     12     4        (object header)                           11 00 00 00 (00010001 00000000 00000000 00000000) (17)\n     16    17   byte [B.<elements>                             N/A\n     33     7        (loss due to the next object alignment)\nInstance size: 40 bytes\nSpace losses: 0 bytes internal + 7 bytes external = 7 bytes total\n\n[C object internals:\n OFFSET  SIZE   TYPE DESCRIPTION                               VALUE\n      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)\n      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)\n      8     4        (object header)                           f0 1c 00 00 (11110000 00011100 00000000 00000000) (7408)\n     12     4        (object header)                           11 00 00 00 (00010001 00000000 00000000 00000000) (17)\n     16    34   char [C.<elements>                             N/A\n     50     6        (loss due to the next object alignment)\nInstance size: 56 bytes\nSpace losses: 0 bytes internal + 6 bytes external = 6 bytes total\n")),(0,r.yg)("p",null,"In the second case for ",(0,r.yg)("inlineCode",{parentName:"p"},"Bartosz Jablonski"),", where we did not include Polish characters, you can see that String has the coder flag set to 0, i.e. it uses LATIN-1 encoding (1 byte per character)."),(0,r.yg)("p",null,"The footprint shows the deep size of the String object (17 characters) is 64 bytes. It consists of String and its metadata and the String object, i.e. the byte[] array in LATIN-1 encoding (1 byte per character)."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"String with a reference takes 24 bytes (12 bytes for metadata (headers) + 4 bytes for hash(int) + 1 byte for coder + 1 byte for hashIsZero + 4 bytes for references to the array of entities + 2 bytes for alligment padding)."),(0,r.yg)("li",{parentName:"ul"},"The byte[] array takes 40 bytes, which consists of: 12 bytes of metadata (headers) + 4 bytes of metadata about the array (length) + 17 character data * 1 byte (17 bytes) = 33 bytes + 7 bytes for alignment.")),(0,r.yg)("p",null,"This is illustrated by the line of code: ",(0,r.yg)("inlineCode",{parentName:"p"},"System.out.println(ClassLayout.parseInstance(latin1String.getBytes()).toPrintable());")),(0,r.yg)("p",null,"Thanks to the ",(0,r.yg)("inlineCode",{parentName:"p"},"coder")," flag and the lack of special characters, we have a gain of 16 bytes in less memory consumption - which happens without our programming intervention."))}g.isMDXComponent=!0},5680:(e,t,n)=>{n.d(t,{xA:()=>y,yg:()=>p});var a=n(6540);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},y=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},b="mdxType",g={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,y=i(e,["components","mdxType","originalType","parentName"]),b=c(n),h=r,p=b["".concat(l,".").concat(h)]||b[h]||g[h]||o;return n?a.createElement(p,s(s({ref:t},y),{},{components:n})):a.createElement(p,s({ref:t},y))}));function p(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=h;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[b]="string"==typeof e?e:r,s[1]=i;for(var c=2;c<o;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"}}]);