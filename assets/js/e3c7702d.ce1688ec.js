"use strict";(self.webpackChunklearning_notes=self.webpackChunklearning_notes||[]).push([[4728],{46304:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>c,toc:()=>l});var r=t(85893),o=t(11151);const s={toc_max_heading_level:4},i="Proxy",c={id:"Web/JavaScript/proxy",title:"Proxy",description:"meta programming.",source:"@site/docs/Web/JavaScript/05-proxy.md",sourceDirName:"Web/JavaScript",slug:"/Web/JavaScript/proxy",permalink:"/docs/Web/JavaScript/proxy",draft:!1,unlisted:!1,editUrl:"https://github.com/xiaohai-huang/learning-notes/tree/master/docs/Web/JavaScript/05-proxy.md",tags:[],version:"current",lastUpdatedBy:"xiaohai-huang",lastUpdatedAt:1695964360,formattedLastUpdatedAt:"29 Sept 2023",sidebarPosition:5,frontMatter:{toc_max_heading_level:4},sidebar:"notesSidebar",previous:{title:"\ud83e\uddec Prototype",permalink:"/docs/Web/JavaScript/prototype"},next:{title:"\u267b\ufe0f Event Loop",permalink:"/docs/Web/JavaScript/event-loop"}},a={},l=[{value:"Syntax",id:"syntax",level:2},{value:"Handler Function / Trap",id:"handler-function",level:3},{value:"<code>get()</code>",id:"get",level:4},{value:"<code>this</code>-recovering Proxy",id:"this-recovering-proxy",level:4},{value:"<code>set()</code>",id:"set",level:4},{value:"Revocable Proxy",id:"revocable-proxy",level:3},{value:"Reflect API",id:"reflect-api",level:2},{value:"Default Forwarding Behavior for Proxy Traps",id:"default-forwarding-behavior-for-proxy-traps",level:3},{value:"A Better <code>apply()</code> Function",id:"a-better-apply-function",level:3},{value:"More Useful Return Values",id:"more-useful-return-values",level:3},{value:"References",id:"references",level:2}];function d(e){const n=Object.assign({h1:"h1",p:"p",ul:"ul",li:"li",img:"img",admonition:"admonition",h2:"h2",code:"code",strong:"strong",em:"em",pre:"pre",h3:"h3",a:"a",blockquote:"blockquote",h4:"h4"},(0,o.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"proxy",children:"Proxy"}),"\n",(0,r.jsx)(n.p,{children:"meta programming."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"operate while the code is running."}),"\n",(0,r.jsx)(n.li,{children:"enables powerful intercession."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["It is similar to a reverse Proxy in a traditional server-client environment.\n",(0,r.jsx)(n.img,{alt:"proxy server",src:t(92562).Z+"",width:"803",height:"430"})]}),"\n",(0,r.jsx)(n.p,{children:'We are able to intercept, define, custom behavior for fundamental language operations. (e.g., "property lookup", "assignment", "enumeration", "function invocation", etc.).'}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"js proxy",src:t(40038).Z+"",width:"813",height:"407"})}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsx)(n.p,{children:"Proxies cannot be transpiled or polyfilled."})}),"\n",(0,r.jsx)(n.h2,{id:"syntax",children:"Syntax"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"const proxy = new Proxy(target, handler)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"target"})," - can be any object. e.g., ",(0,r.jsx)(n.code,{children:"{}"}),", ",(0,r.jsx)(n.code,{children:"[]"}),", ",(0,r.jsx)(n.code,{children:"function() {}"}),", or even another proxy ",(0,r.jsx)(n.code,{children:"new Proxy(...)"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"handler"})," - used to define ",(0,r.jsx)(n.em,{children:"traps"})," aka., the custom behavior of the proxy."]}),"\n"]}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsxs)(n.p,{children:["proxy is transparent. No additional type is added to the ",(0,r.jsx)(n.code,{children:"target"}),". If you use ",(0,r.jsx)(n.code,{children:"typeof"})," operator on the proxy object, it will still return the original data type. No such a type called ",(0,r.jsx)(n.code,{children:"Proxy"}),"."]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"const proxy = new Proxy(() => {}, {});\n\nconsole.log(typeof proxy); // this will log function\nconsole.log(proxy instanceof Proxy);\n// Error: Function has non-object prototype 'undefined' in instanceof check\n"})})]}),"\n",(0,r.jsx)(n.h3,{id:"handler-function",children:"Handler Function / Trap"}),"\n",(0,r.jsxs)(n.p,{children:["Handler functions are sometimes called ",(0,r.jsx)(n.em,{children:"traps"}),", because they trap calls to the underlying ",(0,r.jsx)(n.code,{children:"target"})," object. They are functions that define the behavior for the corresponding ",(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy#object_internal_methods",children:"object internal method"}),"."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"proxy handler functions",src:t(88276).Z+"",width:"371",height:"331"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"internal methods",src:t(98451).Z+"",width:"651",height:"704"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"It's important to realize that all interactions with an object eventually boils down to the invocation of one of these internal methods, and that they are all customizable through proxies."}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"get",children:(0,r.jsx)(n.code,{children:"get()"})}),"\n",(0,r.jsx)(n.p,{children:"To customize the proxy, we can define functions on the handler object."}),"\n",(0,r.jsxs)(n.p,{children:["In this example, we provide an implementation of the ",(0,r.jsx)(n.code,{children:"get(target, property, receiver)"})," handler, which intercepts calls to access properties in the ",(0,r.jsx)(n.code,{children:"target"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",metastring:'title="plain object"',children:'const obj = {\n  name: "xiaohai",\n  language: "javascript",\n};\n\nconst proxy = new Proxy(obj, {\n  // highlight-start\n  get(target, property, receiver) {\n    return "defined by the proxy";\n  },\n  // highlight-end\n});\n\nconsole.log(proxy.name); // \'defined by the proxy\'\nconsole.log(proxy.language); // \'defined by the proxy\'\n'})}),"\n",(0,r.jsxs)(n.h4,{id:"this-recovering-proxy",children:[(0,r.jsx)(n.code,{children:"this"}),"-recovering Proxy"]}),"\n",(0,r.jsxs)(n.p,{children:["A proxy is still another object with different identity. It operates between the wrapped object (",(0,r.jsx)(n.code,{children:"target"}),") and the outside. As such, the proxy does not have direct access to the original object's private properties for example."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'class Secret {\n  #secret;\n  constructor(secret) {\n    this.#secret = secret;\n  }\n  get secret() {\n    // highlight-next-line\n    return this.#secret.replace(/\\d+/, "[REDACTED]");\n  }\n}\n\nconst aSecret = new Secret("123456");\nconsole.log(aSecret.secret); // [REDACTED]\n// Looks like a no-op forwarding...\nconst proxy = new Proxy(aSecret, {});\nconsole.log(proxy.secret); // TypeError: Cannot read private member #secret from an object whose class did not declare it\n'})}),"\n",(0,r.jsxs)(n.p,{children:["When the ",(0,r.jsx)(n.code,{children:"get secret() {}"})," is invoked, the ",(0,r.jsx)(n.code,{children:"this"})," value is the ",(0,r.jsx)(n.code,{children:"proxy"})," variable instead of the original ",(0,r.jsx)(n.code,{children:"secret"})," variable, so ",(0,r.jsx)(n.code,{children:"this.#secret"})," will result in an error. To fix this, point ",(0,r.jsx)(n.code,{children:"this"})," to the ",(0,r.jsx)(n.code,{children:"secret"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"const proxy = new Proxy(aSecret, {\n  get(target, prop, receiver) {\n    // highlight-next-line\n    proxy === receiver; // true\n    // By default, it looks like Reflect.get(target, prop, receiver)\n    // which causes the value of `this` in `get secret()` to be `proxy`\n\n    // highlight-start\n    return Reflect.get(target, prop, target);\n    // return target[prop];\n    // highlight-end\n  },\n});\nconsole.log(proxy.secret);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Redirects ",(0,r.jsx)(n.strong,{children:"methods"}),"'s ",(0,r.jsx)(n.code,{children:"this"})," value to the original object:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"const proxy = new Proxy(obj, {\n  get(target, property, receiver) {\n    // highlight-start\n    // redirect `this` to the original object `target`\n    const value = Reflect.get(target, property, target);\n    // highlight-end\n\n    if (value instanceof Function) {\n      // highlight-start\n      // redirect `this` to the original object `target`\n      return (...args) => Reflect.apply(value, target, args);\n      // highlight-end\n    }\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h4,{id:"set",children:(0,r.jsx)(n.code,{children:"set()"})}),"\n",(0,r.jsxs)(n.p,{children:["We can perform validations by overriding the ",(0,r.jsx)(n.code,{children:"set(target, property, newValue)"})," handler."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'const validator = {\n  set(obj, prop, value) {\n    if (prop === "age") {\n      if (!Number.isInteger(value)) {\n        throw new TypeError("The age is not an integer");\n      }\n      if (value > 200) {\n        throw new RangeError("The age seems invalid");\n      }\n    }\n\n    // The default behavior to store the value\n    obj[prop] = value;\n\n    // Indicate success\n    return true;\n  },\n};\n\nconst person = new Proxy({}, validator);\n\nperson.age = 100;\nconsole.log(person.age); // 100\nperson.age = "young"; // Throws an exception\nperson.age = 300; // Throws an exception\n'})}),"\n",(0,r.jsx)(n.h3,{id:"revocable-proxy",children:"Revocable Proxy"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"Proxy.revocable()"})," method can create a revocable ",(0,r.jsx)(n.code,{children:"Proxy"})," object."]}),"\n",(0,r.jsxs)(n.p,{children:["This means that the proxy can be revoked via the function ",(0,r.jsx)(n.code,{children:"revoke"})," and switches the proxy off. After switching off the proxy, any operation on the proxy leads to a ",(0,r.jsx)(n.code,{children:"TypeError"})," (including ",(0,r.jsx)(n.em,{children:"operations"})," that are not defined in the ",(0,r.jsx)(n.code,{children:"handler"}),")."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"const revocable = Proxy.revocable(\n  {},\n  {\n    get(target, name) {\n      return `[[${name}]]`;\n    },\n  }\n);\n\nconst proxy = revocable.proxy;\nconsole.log(proxy.foo); // \"[[foo]]\"\n\nrevocable.revoke();\n\nconsole.log(proxy.foo); // TypeError: Cannot perform 'get' on a proxy that has been revoked\nproxy.foo = 1; // TypeError: Cannot perform 'set' on a proxy that has been revoked\nconsole.log(typeof proxy); // \"object\", typeof doesn't trigger any trap\n"})}),"\n",(0,r.jsx)(n.h2,{id:"reflect-api",children:"Reflect API"}),"\n",(0,r.jsxs)(n.p,{children:["Most methods in this module map one-to-one onto Proxy traps. ",(0,r.jsx)(n.a,{href:"#handler-function",children:"Proxy handlers"})," can use these methods to conveniently ",(0,r.jsx)(n.strong,{children:"forward operations"}),". The return type of the Reflect methods is guaranteed to be compatible with the return type of the Proxy traps."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"1 to 1 mapping",src:t(36966).Z+"",width:"726",height:"352"})}),"\n",(0,r.jsx)(n.h3,{id:"default-forwarding-behavior-for-proxy-traps",children:"Default Forwarding Behavior for Proxy Traps"}),"\n",(0,r.jsxs)(n.p,{children:["When using ",(0,r.jsx)(n.code,{children:"Proxy"}),' to wrap existing objects, it is very common to intercept an operation, do something, and then to "',(0,r.jsx)(n.strong,{children:"do the default thing"}),'".']}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"Reflect"})," and ",(0,r.jsx)(n.code,{children:"Proxy"})," APIs were ",(0,r.jsx)(n.em,{children:"designed to work together"}),", such that for each ",(0,r.jsx)(n.code,{children:"Proxy"})," trap, there exists a corresponding method on ",(0,r.jsx)(n.code,{children:"Reflect"}),' that "',(0,r.jsx)(n.strong,{children:"does the default thing"}),'". Hence, whenever you find yourself wanting to "',(0,r.jsx)(n.strong,{children:"do the default thing"}),'" inside a ',(0,r.jsx)(n.a,{href:"#handler-function",children:"Proxy handler"}),", the correct thing to do is to always call the corresponding method in the ",(0,r.jsx)(n.code,{children:"Reflect"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:'const obj = {\n  name: "xiaohai",\n  age: 29,\n};\nconst proxy = new Proxy(obj, {\n  get(target, property) {\n    // do something\n    // highlight-next-line\n    console.log("!!getting ", property);\n\n    // do the default thing\n    // highlight-start\n    return Reflect.get(...arguments);\n    // return Reflect.get(target, property);\n    // compatible with the return type of the trap.\n    // highlight-end\n  },\n});\n\nconsole.log(proxy.age);\n// !!getting age\n// 29\n'})}),"\n",(0,r.jsxs)(n.p,{children:["In addition to helping with forwarding default operations from the proxy handler to the ",(0,r.jsx)(n.code,{children:"target"}),", ",(0,r.jsx)(n.code,{children:"Reflect"})," also provides a few benefits."]}),"\n",(0,r.jsxs)(n.h3,{id:"a-better-apply-function",children:["A Better ",(0,r.jsx)(n.code,{children:"apply()"})," Function"]}),"\n",(0,r.jsxs)(n.p,{children:["Before ",(0,r.jsx)(n.code,{children:"Reflect"}),", if we want to call a function with a given ",(0,r.jsx)(n.code,{children:"this"})," and ",(0,r.jsx)(n.code,{children:"arguments"})," (in an array format), we would need to use ",(0,r.jsx)(n.code,{children:"Function.prototype.apply(...)"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",metastring:'title="\ud83d\udc74 old style"',children:"Function.prototype.apply.call(Math.floor, undefined, [1.75]);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["With ",(0,r.jsx)(n.code,{children:"Reflect"})," this becomes less verbose and easier to understand:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",metastring:'title="\ud83d\ude0e new style"',children:"Reflect.apply(Math.floor, undefined, [1.75]);\n"})}),"\n",(0,r.jsxs)(n.admonition,{type:"info",children:[(0,r.jsxs)(n.p,{children:["Why use ",(0,r.jsx)(n.code,{children:"Function.prototype.apply.call"})," instead of ",(0,r.jsx)(n.code,{children:"func.apply"}),"?"]}),(0,r.jsxs)(n.p,{children:["Ans: a function might define its own ",(0,r.jsx)(n.code,{children:"apply"})," method."]}),(0,r.jsxs)(n.p,{children:["In order to make sure that the built-in ",(0,r.jsx)(n.code,{children:"apply"})," function is called, we should use ",(0,r.jsx)(n.code,{children:"Function.prototype.apply.call(f, obj, args)"}),"\ud83d\udc74 or the newer ",(0,r.jsx)(n.code,{children:"Reflect.apply(f, obj, args)"}),"\ud83d\ude0e."]})]}),"\n",(0,r.jsx)(n.h3,{id:"more-useful-return-values",children:"More Useful Return Values"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["Many operations in ",(0,r.jsx)(n.code,{children:"Reflect"})," are similar to ES5 operations defined on ",(0,r.jsx)(n.code,{children:"Object"}),", such as ",(0,r.jsx)(n.code,{children:"Reflect.getOwnPropertyDescriptor"})," and ",(0,r.jsx)(n.code,{children:"Reflect.defineProperty"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\ud83d\udc74 ",(0,r.jsx)(n.code,{children:"Object.defineProperty(obj, name, desc)"})," will either return ",(0,r.jsx)(n.code,{children:"obj"})," when the property was successfully defined, or throw a ",(0,r.jsx)(n.code,{children:"TypeError"})," otherwise."]}),"\n",(0,r.jsxs)(n.p,{children:["\ud83d\ude0e ",(0,r.jsx)(n.code,{children:"Reflect.defineProperty(obj, name, desc)"})," simply returns a ",(0,r.jsx)(n.strong,{children:"boolean"})," that indicates whether or not the property was ",(0,r.jsx)(n.strong,{children:"successfully"})," defined."]}),"\n",(0,r.jsxs)(n.p,{children:["This enables us to get rid of the ",(0,r.jsx)(n.code,{children:"try-catch"})," block:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",metastring:'title="\ud83d\udc74 old style"',children:"try {\n  Object.defineProperty(obj, name, desc);\n  // property defined successfully\n} catch (e) {\n  // possible failure\n  // (and might accidentally catch the wrong exception)\n}\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",metastring:'title="\ud83d\ude0e new style"',children:"if (Reflect.defineProperty(obj, name, desc)) {\n  // success\n} else {\n  // failure\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsxs)(n.a,{href:"https://www.stefanjudis.com/today-i-learned/the-global-reflect-object-its-use-cases-and-things-to-watch-out-for/",children:["The global ",(0,r.jsx)(n.code,{children:"Reflect"})," object, its use cases and things to watch out for"]})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://stackoverflow.com/a/25585988",children:"What does the Reflect object do in JavaScript? | stackoverflow"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Meta_programming",children:"Meta Programming | MDN"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy",children:"Proxy | MDN"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.youtube.com/watch?v=_5X2aB_mNp4",children:"Eirik Vullum: JavaScript Metaprogramming - ES6 Proxy Use and Abuse | JSConf Budapest 2017"})}),"\n"]})]})}const h=function(e={}){const{wrapper:n}=Object.assign({},(0,o.ah)(),e.components);return n?(0,r.jsx)(n,Object.assign({},e,{children:(0,r.jsx)(d,e)})):d(e)}},36966:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/1-1-mapping-between-proxy-traps-reflect-0dc3520c650274f98f8c2671b18c393d.png"},98451:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/internal-methods-60270dc9bd8f182aa007a91b49bfae0b.png"},40038:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/js-proxy-306378ae298b5812b526a6e33bc716e2.png"},88276:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/proxy-handler-functions-f7616284283d8a65619f66d23677e00c.png"},92562:(e,n,t)=>{t.d(n,{Z:()=>r});const r=t.p+"assets/images/proxy-server-ec64655a60282a963e7bf0c361d793f6.png"},11151:(e,n,t)=>{t.d(n,{Zo:()=>c,ah:()=>s});var r=t(67294);const o=r.createContext({});function s(e){const n=r.useContext(o);return r.useMemo((()=>"function"==typeof e?e(n):{...n,...e}),[n,e])}const i={};function c({components:e,children:n,disableParentContext:t}){let c;return c=t?"function"==typeof e?e({}):e||i:s(e),r.createElement(o.Provider,{value:c},n)}}}]);